<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Websocket Tester</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      #messages {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        max-width: 600px;
        background: #f9f9f9;
      }
      .message {
        padding: 8px;
        margin: 8px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .notification {
        background: #e3f7d3;
      }
      .user-message {
        background: #d3e2f7;
      }
      .ack {
        background: #f7ecd3;
      }
      button.small {
        padding: 3px 6px;
        font-size: 12px;
        margin-left: 8px;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Tester</h1>

    <button id="notifyBtn">Send Notification</button>

    <div id="messages"></div>

  <script>
    const userId = "123";

    // Determine ws:// or wss:// automatically
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(
      `${wsProtocol}://${window.location.host}/api/ws?user_id=${userId}&client_name=test`
    );

    ws.onopen = () => {
      console.log("Connected");
      ws.send("Hello from browser");
    };

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      console.log("Event Received:", msg);
    };

    ws.onclose = () => console.log("Disconnected");

    // ---- Button Actions ----
    document.getElementById("notifyBtn").onclick = () => {
      fetch("/api/notification/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          payload: { text: "Hello from API button!" },
        }),
      })
        .then(r => r.json())
        .then(console.log)
        .catch(console.error);
    };

    function acknowledgeMessage(messageId) {
      fetch("/api/notification/acknowledge", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          message_ids: [messageId],
        }),
      }).then(() => console.log("Acknowledged:", messageId));
    }
  </script>
  </body>
</html>